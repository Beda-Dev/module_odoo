<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Template : Page d'accueil cantine -->
    <template id="cantine_home" name="Accueil Cantine">
        <t t-call="website.layout">
            <div id="wrap" class="oe_structure">
                <div class="container mt-5 mb-5">
                    <div class="row">
                        <div class="col-lg-8 offset-lg-2">
                            <div class="text-center mb-5">
                                <h1 class="display-4">Restaurant des Lagunes</h1>
                                <p class="lead">Cantine d'entreprise</p>
                            </div>
                            
                            <div class="card shadow">
                                <div class="card-body p-5">
                                    <h3 class="card-title mb-4">Accès MyCantine</h3>
                                    <p class="text-muted">Veuillez entrer vos informations pour accéder à votre menu</p>
                                    
                                    <form id="accessForm" class="needs-validation" novalidate="">
                                        <div class="mb-4">
                                            <label for="access_code" class="form-label">Code entreprise</label>
                                            <input type="password" 
                                                   class="form-control form-control-lg" 
                                                   id="access_code" 
                                                   name="access_code" 
                                                   placeholder="Entrez le code d'accès"/>
                                            <div class="form-text">Entrez le code d'accès fourni par votre entreprise.</div>
                                        </div>
                                        
                                        <div id="error_message" class="alert alert-danger d-none" role="alert"></div>
                                        
                                        <button type="submit" class="btn btn-primary btn-lg w-100 py-3 shadow-sm transition-all hover-up">
                                            <i class="fa fa-sign-in me-2"/> Accéder au menu du jour
                                        </button>
                                    </form>

                                    <script type="text/javascript">
                                        document.addEventListener('DOMContentLoaded', function() {
                                            const form = document.getElementById('accessForm');
                                            
                                            form.addEventListener('submit', function(e) {
                                                e.preventDefault();
                                                
                                                if (!form.checkValidity()) {
                                                    e.stopPropagation();
                                                    form.classList.add('was-validated');
                                                    return;
                                                }
                                                
                                                const accessCode = document.getElementById('access_code')?.value || null;
                                                
                                                fetch('/cantine/verify_access', {
                                                    method: 'POST',
                                                    headers: {
                                                        'Content-Type': 'application/json',
                                                    },
                                                    body: JSON.stringify({
                                                        jsonrpc: '2.0',
                                                        method: 'call',
                                                        params: {
                                                            access_code: accessCode
                                                        }
                                                    })
                                                })
                                                .then(response => response.json())
                                                .then(data => {
                                                    if (data.result &amp;&amp; data.result.success) {
                                                        window.location.href = `/cantine/menu/${data.result.entreprise_id}`;
                                                    } else {
                                                        const errorDiv = document.getElementById('error_message');
                                                        errorDiv.textContent = data.result?.message || 'Erreur d\'accès';
                                                        errorDiv.classList.remove('d-none');
                                                    }
                                                })
                                                .catch(error => {
                                                    const errorDiv = document.getElementById('error_message');
                                                    errorDiv.textContent = 'Erreur de connexion';
                                                    errorDiv.classList.remove('d-none');
                                                });
                                            });
                                        });
                                    </script>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Template : Page d'accès entreprise -->
    <template id="cantine_access" name="Accès Entreprise">
        <t t-call="website.layout">
            <div id="wrap" class="oe_structure">
                <div class="container mt-5 mb-5">
                    <div class="row">
                        <div class="col-lg-6 offset-lg-3">
                            <div class="card shadow">
                                <div class="card-header bg-primary text-white">
                                    <h4 class="mb-0">
                                        <i class="fa fa-building"/> <t t-esc="entreprise.name"/>
                                    </h4>
                                </div>
                                <div class="card-body p-4">
                                    <h5 class="mb-4">Accès au menu</h5>
                                    <p class="text-muted">Veuillez entrer vos informations pour accéder au menu du jour</p>
                                    
                                    <form id="accessForm" class="needs-validation" novalidate="">
                                        <div class="mb-3">
                                            <label for="access_code" class="form-label">Code d'accès *</label>
                                            <input type="password" 
                                                   class="form-control" 
                                                   id="access_code" 
                                                   name="access_code" 
                                                   required="" 
                                                   placeholder="Entrez le code d'accès"/>
                                            <div class="invalid-feedback">
                                                Le code d'accès est requis
                                            </div>
                                        </div>
                                        
                                        <input type="hidden" id="entreprise_id" t-att-value="entreprise.id"/>
                                        
                                        <div id="error_message" class="alert alert-danger d-none" role="alert"></div>
                                        
                                        <button type="submit" class="btn btn-primary btn-lg w-100">
                                            <i class="fa fa-sign-in"/> Accéder au menu
                                        </button>
                                    </form>
                                    
                                    <div class="mt-3 text-center">
                                        <a href="/cantine" class="text-muted">
                                            <i class="fa fa-arrow-left"/> Retour
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Script de validation et soumission -->
            <script type="text/javascript">
                document.addEventListener('DOMContentLoaded', function() {
                    const form = document.getElementById('accessForm');
                    
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        if (!form.checkValidity()) {
                            e.stopPropagation();
                            form.classList.add('was-validated');
                            return;
                        }
                        
                        const entrepriseId = parseInt(document.getElementById('entreprise_id').value);
                        const accessCode = document.getElementById('access_code')?.value || null;
                        
                        // Appel AJAX
                        fetch('/cantine/verify_access', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                jsonrpc: '2.0',
                                method: 'call',
                                params: {
                                    entreprise_id: entrepriseId,
                                    access_code: accessCode
                                }
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.result &amp;&amp; data.result.success) {
                                window.location.href = `/cantine/menu/${entrepriseId}`;
                            } else {
                                const errorDiv = document.getElementById('error_message');
                                errorDiv.textContent = data.result?.message || 'Erreur d\'accès';
                                errorDiv.classList.remove('d-none');
                            }
                        })
                        .catch(error => {
                            const errorDiv = document.getElementById('error_message');
                            errorDiv.textContent = 'Erreur de connexion';
                            errorDiv.classList.remove('d-none');
                        });
                    });
                });
            </script>
        </t>
    </template>
    
    <!-- Template : Page d'erreur -->
    <template id="error_page" name="Page d'erreur">
        <t t-call="website.layout">
            <div id="wrap" class="oe_structure">
                <div class="container mt-5 mb-5">
                    <div class="row">
                        <div class="col-lg-6 offset-lg-3 text-center">
                            <div class="alert alert-danger">
                                <h3><i class="fa fa-exclamation-triangle"/> Erreur</h3>
                                <p t-esc="error_message"/>
                            </div>
                            <a href="/cantine" class="btn btn-primary">
                                <i class="fa fa-home"/> Retour à l'accueil
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

</odoo>
