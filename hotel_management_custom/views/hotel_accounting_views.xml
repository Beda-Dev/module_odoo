<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extension de la vue formulaire des paiements -->
    <record id="view_account_payment_form_inherit_hotel" model="ir.ui.view">
        <field name="name">account.payment.form.inherit.hotel</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account.view_account_payment_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='memo']" position="after">
                <field name="reservation_id" readonly="1"/>
                <field name="is_advance_payment" invisible="1"/>
            </xpath>
        </field>
    </record>

    <!-- Extension de la vue liste des paiements -->
    <record id="view_account_payment_tree_inherit_hotel" model="ir.ui.view">
        <field name="name">account.payment.list.inherit.hotel</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account.view_account_payment_tree"/>
        <field name="arch" type="xml">
            <field name="partner_id" position="after">
                <field name="reservation_id" optional="show"/>
            </field>
        </field>
    </record>

    <!-- Extension de la vue recherche des paiements -->
    <record id="view_account_payment_search_inherit_hotel" model="ir.ui.view">
        <field name="name">account.payment.search.inherit.hotel</field>
        <field name="model">account.payment</field>
        <field name="inherit_id" ref="account.view_account_payment_search"/>
        <field name="arch" type="xml">
            <field name="partner_id" position="after">
                <field name="reservation_id"/>
            </field>
            <filter name="state_draft" position="after">
                <separator/>
                <filter string="Paiements R√©servations" name="advance_payments" 
                        domain="[('is_advance_payment', '=', True)]"/>
            </filter>
        </field>
    </record>

    <data>

        <!-- ============= VUE FOLIO AM√âLIOR√âE ============= -->
        <record id="view_hotel_folio_form_accounting" model="ir.ui.view">
            <field name="name">hotel.folio - Comptabilit√©</field>
            <field name="model">hotel.folio</field>
            <field name="inherit_id" ref="view_hotel_folio_form"/>
            <field name="arch" type="xml">
                <xpath expr="//page[@name='notes']" position="before">
                    <page name="accounting" string="Comptabilit√©" groups="account.group_account_user">
                        <group string="Statut Facturation">
                            <field name="invoice_status" widget="badge" 
                                   decoration-danger="invoice_status == 'not_invoiced'"
                                   decoration-warning="invoice_status == 'partial'"
                                   decoration-success="invoice_status == 'invoiced'"/>
                        </group>

                        <group string="Factures">
                            <field name="invoice_ids" readonly="1" nolabel="1">
                                <list>
                                    <field name="name"/>
                                    <field name="date"/>
                                    <field name="state" widget="badge"/>
                                    <field name="amount_total" widget="monetary"/>
                                </list>
                            </field>
                        </group>

                        <group string="√âcritures Comptables">
                            <field name="accounting_move_ids" readonly="1" nolabel="1">
                                <list>
                                    <field name="name"/>
                                    <field name="date"/>
                                    <field name="state" widget="badge"/>
                                </list>
                            </field>
                            <button name="action_open_accounting_entries" type="object" 
                                    string="Voir D√©tail" class="oe_link" 
                                    invisible="not accounting_move_ids"/>
                        </group>
                    </page>
                </xpath>
            </field>
        </record>

        <!-- ============= VUE R√âSERVATION AM√âLIOR√âE (ONGLET COMPTABILIT√â) ============= -->
        <record id="view_hotel_reservation_form_accounting" model="ir.ui.view">
            <field name="name">hotel.reservation - Comptabilit√©</field>
            <field name="model">hotel.reservation</field>
            <field name="inherit_id" ref="view_hotel_reservation_form"/>
            <field name="arch" type="xml">
                <!-- Ajouter l'onglet comptabilit√© apr√®s les notes -->
                <xpath expr="//page[@name='notes']" position="after">
                    <page name="accounting" string="Comptabilit√©" 
                          groups="account.group_account_user"
                          invisible="state == 'cancelled'">
                        
                        <!-- Section Acomptes - Visible uniquement si activ√© -->
                        <group string="Gestion des Acomptes" 
                               invisible="not require_deposit">
                            <group>
                                <field name="deposit_percentage" readonly="1" widget="percentage"/>
                                <field name="deposit_amount" widget="monetary" readonly="1"/>
                                <field name="deposit_paid" widget="monetary" readonly="1"/>
                                <field name="deposit_date" readonly="1"/>
                                <field name="advance_payment_status" widget="badge"
                                       decoration-danger="advance_payment_status == 'none'"
                                       decoration-warning="advance_payment_status == 'partial'"
                                       decoration-success="advance_payment_status in ['deposit_paid', 'full_paid']"/>
                            </group>
                            <group>
                                <button name="action_request_deposit" type="object" 
                                        string="üìù Demander Acompte" 
                                        class="oe_highlight"
                                        invisible="deposit_paid &gt;= deposit_amount or state not in ['draft', 'confirmed']"/>
                                
                                <button name="action_register_advance_payment" type="object" 
                                        string="üí≥ Paiement Anticip√©" 
                                        class="btn-primary"
                                        invisible="amount_paid &gt;= total_amount or state not in ['draft', 'confirmed']"/>
                            </group>
                        </group>

                        <!-- Section Paiements d'Avance -->
                        <group string="Historique des Paiements Anticip√©s" 
                               invisible="not advance_payment_ids">
                            <field name="advance_payment_ids" readonly="1" nolabel="1">
                                <list>
                                    <field name="date"/>
                                    <field name="amount" widget="monetary" sum="Total"/>
                                    <field name="hotel_payment_method_id"/>
                                    <field name="mobile_phone" optional="hide"/>
                                    <field name="mobile_reference" optional="hide"/>
                                    <field name="state" widget="badge"
                                           decoration-success="state == 'paid'"
                                           decoration-info="state == 'draft'"/>
                                    <field name="is_advance_payment" column_invisible="1"/>
                                </list>
                            </field>
                        </group>

                        <!-- Section √âcritures Comptables -->
                        <group string="√âcritures Comptables">
                            <field name="accounting_move_ids" readonly="1" nolabel="1">
                                <list>
                                    <field name="name"/>
                                    <field name="date"/>
                                    <field name="journal_id"/>
                                    <field name="amount_total" widget="monetary"/>
                                    <field name="state" widget="badge"
                                           decoration-success="state == 'paid'"
                                           decoration-info="state == 'draft'"/>
                                </list>
                            </field>
                        </group>

                        <!-- R√©sum√© financier -->
                        <group string="R√©sum√© Financier">
                            <group>
                                <label for="total_amount" string="Montant Total"/>
                                <div>
                                    <field name="total_amount" widget="monetary" class="oe_inline" readonly="1"/>
                                </div>
                                
                                <label for="deposit_paid" string="Paiements Anticip√©s" 
                                       invisible="not require_deposit or not deposit_paid"/>
                                <div invisible="not require_deposit or not deposit_paid">
                                    <field name="deposit_paid" widget="monetary" class="oe_inline" readonly="1"/>
                                </div>
                            </group>
                            <group>
                                <label for="amount_paid" string="Total Pay√©"/>
                                <div>
                                    <field name="amount_paid" widget="monetary" class="oe_inline" readonly="1"/>
                                </div>
                                
                                <label for="amount_due" string="Solde Restant" class="oe_subtotal_footer_separator"/>
                                <div class="oe_subtotal_footer_separator">
                                    <field name="amount_due" widget="monetary" class="oe_inline" readonly="1"/>
                                </div>
                            </group>
                        </group>

                    </page>
                </xpath>
            </field>
        </record>

        <!-- ============= VUE MODE PAIEMENT AM√âLIOR√âE ============= -->
        <record id="view_hotel_payment_method_form_accounting" model="ir.ui.view">
            <field name="name">hotel.payment.method - Comptabilit√©</field>
            <field name="model">hotel.payment.method</field>
            <field name="inherit_id" ref="view_hotel_payment_method_form"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='require_reference']/.." position="after">
                    <group string="Configuration Comptable" groups="account.group_account_manager">
                        <field name="account_debit_id" 
                               domain="[('deprecated', '=', False), ('account_type', '!=', 'asset_receivable')]"
                               help="Compte o√π d√©biter le paiement (ex: Caisse, Banque)"/>
                        <field name="account_credit_id" 
                               domain="[('deprecated', '=', False), ('account_type', '=', 'asset_receivable')]"
                               help="Compte client o√π cr√©diter le paiement"/>
                    </group>
                </xpath>
            </field>
        </record>

        <!-- ============= RAPPORT COMPTABLE ============= -->
        <record id="view_hotel_accounting_report_list" model="ir.ui.view">
            <field name="name">hotel.accounting.report - Liste</field>
            <field name="model">hotel.accounting.report</field>
            <field name="arch" type="xml">
                <list string="Rapport Comptable">
                    <field name="folio_id"/>
                    <field name="partner_id"/>
                    <field name="room_id"/>
                    <field name="checkin_date"/>
                    <field name="checkout_date"/>
                    <field name="amount_total" sum="Total"/>
                    <field name="amount_paid" sum="Total Pay√©"/>
                    <field name="advance_paid" sum="Acomptes" optional="hide"/>
                    <field name="amount_due" sum="Total D√ª"/>
                    <field name="invoice_count"/>
                    <field name="payment_count"/>
                    <field name="state" widget="badge"
                           decoration-success="state == 'closed'"
                           decoration-info="state == 'open'"/>
                </list>
            </field>
        </record>

        <record id="view_hotel_accounting_report_pivot" model="ir.ui.view">
            <field name="name">hotel.accounting.report - Pivot</field>
            <field name="model">hotel.accounting.report</field>
            <field name="arch" type="xml">
                <pivot>
                    <field name="checkin_date" interval="month" type="row"/>
                    <field name="state" type="col"/>
                    <field name="amount_total" type="measure"/>
                    <field name="amount_paid" type="measure"/>
                    <field name="amount_due" type="measure"/>
                </pivot>
            </field>
        </record>

        <record id="view_hotel_accounting_report_graph" model="ir.ui.view">
            <field name="name">hotel.accounting.report - Graphique</field>
            <field name="model">hotel.accounting.report</field>
            <field name="arch" type="xml">
                <graph string="Revenus H√¥tel" type="bar" sample="1">
                    <field name="checkin_date" interval="month"/>
                    <field name="amount_total" type="measure"/>
                    <field name="amount_paid" type="measure"/>
                </graph>
            </field>
        </record>

        <!-- ============= ACTION RAPPORT ============= -->
        <record id="action_hotel_accounting_report" model="ir.actions.act_window">
            <field name="name">Rapport Comptable H√¥tel</field>
            <field name="res_model">hotel.accounting.report</field>
            <field name="view_mode">list,pivot,graph</field>
            <field name="context">{}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    üìä Rapport Comptable H√¥tel
                </p>
                <p>
                    Analysez vos r√©servations, factures et paiements en un coup d'≈ìil.<br/>
                    Ce rapport vous permet de suivre vos revenus et paiements anticip√©s.
                </p>
            </field>
        </record>

        <!-- ============= MENU ============= -->
        <menuitem id="menu_hotel_accounting_report"
                  name="Rapport Comptable"
                  parent="hotel_management_custom.menu_hotel_accounting"
                  action="action_hotel_accounting_report"
                  sequence="5"
                  groups="account.group_account_user"/>

    </data>
</odoo>